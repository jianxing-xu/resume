## Desty Menu 基于虚拟滚动和 Intersection Observer 的分页加载

#### 基本功能：
在现有项目与中存在一个商品列表，在商品列表的头部有分类的Tab，在点击分类Tab时，下面的列表就会滚动到对应分类的第一个商品

#### 出现的问题：
在商品数据非常多的时候，后端数据返回明显变慢，且前端渲染卡顿。

#### 协商：
前后端协商进行分页获取数据，但是现有功能是根据分类定位商品位置，且并不清楚一页需要加载多少数据，分页加载方案明显受限。

#### 最后折中方案：
根据单个分类获取商品数据。

#### 前端设计：
1. 首先和后端协商，需要拿到所有的分类数据，以及分类下的商品的个数。
2. 根据商品的分类以及个数，采用虚拟滚动渲染出所有的商品DOM，因为此时还没有商品的具体数据，所以只是渲染了商品的占位DOM以及商品分类标题，并且将当前分类的id和当前分类的下一个id都以html属性的方式传递给标签，以便于下面在 `Intersection Observer` 回调用能够找到。
3. 因为在列表中会将商品分类的标题渲染到这类商品的起始位置，所以我们可以在商品分类表元素上使用 `Intersection Observer` 特性去监听标题元素是否进入屏幕来执行，获取商品的数据的时机，初始渲染会渲染前两个分类的数据，之后会根据 `Intersection Observer` 的回调可以知道当前哪个分类进入屏幕了，我们会拉取当前进入屏幕的分类的数据以及它的下一个分类的数据(预先加载下一个分类的数据)
4. 最后，对于已经加载过的数据不会有第二次加载，在一个分类的数据获取到之后，我们会用一个 `map` 结构标记这个分类的数据已经被加载过了。
5. 点击对应的Tab，会直接加载这个分类的数据。

最终解决问题。


# Desty chat 聊天消息量过大导致的卡顿、

老方案：采用响应式数据库策略，当对应的表发生变动时，会自动发出时间，监听这个事件去查询统计，最后拼接处会话数据，需要查询全表，导致数量量大变慢。

新方案：
统计：更新会话记录的时间，最新消息。 统计会话未读数量。
1. 在会话生成的时候统计一次
2. 有新的聊天消息进来的时候统计一次
3. 统计函数采用节流形式
优势：不需要查询全表统计，统计的数据全部挂在到会话表中，实际根据索引查询速度快。